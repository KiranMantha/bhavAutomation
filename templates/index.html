{% extends "base.html" %}

{% block title %}CSV Upload and Results{% endblock %}

{% block content %}
<div class="card">
  <h2>Upload CSV and Process Data</h2>
  <form id="csvForm" method="post" enctype="multipart/form-data">
    <div>
      <label for="TckrSymb">Ticker Symbol:</label>
      <select id="TckrSymb" name="TckrSymb">
        <option value="NIFTY">NIFTY</option>
        <option value="BANKNIFTY">BANKNIFTY</option>
      </select>
    </div>
    <div>
      <label for="strike_price">Current Strike Price:</label>
      <input
        type="number"
        id="strike_price"
        name="strike_price"
        step="0.01"
        placeholder="e.g., 24000"
      />
    </div>
    <div>
      <label for="XpryDt1">Weekly Expiry Date:</label>
      <input type="date" id="XpryDt1" name="XpryDt1" />
    </div>
    <div>
      <label for="XpryDt2">Monthly Expiry Date:</label>
      <input type="date" id="XpryDt2" name="XpryDt2" />
    </div>
    <div>
      <input type="file" id="csv" name="file" />
    </div>
  </form>
  <button type="submit" form="csvForm">Upload and Process</button>
  <button onclick="window.location.pathname = '/'">Reset</button>
</div>

{% if table %}
  {% set context = {'dataset': table, 'ticker_symbol': TckrSymb} %}
  {% include 'eod-summary.html' with context %}
{% endif %} 

{% if toprecords %}
<div class="strikes">
  {% if toprecords.XpryDt1 %}
    {% set dataset = toprecords.XpryDt1 %}
    {% include 'strikes-table.html' %}
  {% endif %}

  {% set dataset = toprecords.XpryDt2 %}
  {% include 'strikes-table.html' %}
</div>
{% endif %}

<script>
  function displayTableContent() {
    {% if table %}
      // Get all table rows
      const rows = document.querySelectorAll("table tbody tr");

      // Loop through each row and update cells
      rows.forEach((row) => {
        const cells = row.querySelectorAll("td[data-number]");

        cells.forEach((cell) => {
          const rawNumber = Math.round(parseFloat(cell.getAttribute("data-number")));
          // const formattedNumber = numberWithCommas(rawNumber);
          const formattedNumber = rawNumber.toLocaleString("en-IN", {
            maximumFractionDigits: 2,
          });
          cell.textContent = formattedNumber; // Update the text with the formatted number
        });
      });

      const resultRows = JSON.parse('{{ table | tojson | safe }}');
      console.log('{{ TckrSymb }}')
      window.resultRows = resultRows;
      {% endif %}
  }

  document.addEventListener("DOMContentLoaded", () => {
    displayTableContent();
    const tickerSymbol = document.getElementById("TckrSymb");
    const weeklyExpiry = document.getElementById("XpryDt1");

    const updateFieldState = () => {
      if (tickerSymbol.value === "BANKNIFTY") {
        weeklyExpiry.disabled = true;
      } else {
        weeklyExpiry.disabled = false;
      }
      weeklyExpiry.value = ""; // Clear the value if any
    };

    // Initialize the state on page load
    updateFieldState();

    // Update the state whenever the ticker symbol changes
    tickerSymbol.addEventListener("change", updateFieldState);
  });
</script>
{% endblock %}
